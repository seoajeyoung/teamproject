<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwillbs.mappers.TheaterMapper">
	
	<!-- 극장 가져오기 지역 -->
	<select id="getRegionList" resultType="java.util.HashMap">
		SELECT TH_REGION, COUNT(DISTINCT TH_NAME) AS 'COUNT'
		FROM (
		  SELECT TH_NUM, TH_REGION, TH_NAME
		  FROM THEATER
		  ORDER BY TH_NUM
		) AS T
		GROUP BY TH_REGION
		order by TH_REGION DESC;
    </select>
        
	<select id="getAreaList" resultType="com.itwillbs.domain.TheaterDTO">
		SELECT *
		FROM (SELECT TH_NUM
				  , TH_NAME
				  , TH_REGION
				  , TH_ADDR
   				  , ROW_NUMBER() OVER (PARTITION BY TH_NAME, TH_REGION ORDER BY TH_NUM) AS RN
	          FROM THEATER) AS T
		WHERE RN = 1
		ORDER BY TH_NUM;
	</select>
	
	<!-- 해당 극장에서 상영일자만 중복없이 -->
	<select id="getRunningDate" parameterType="map" resultType="map">
		SELECT DISTINCT DATE_FORMAT(S.SC_TIME, '%Y-%m-%d') AS DATE,
			CASE DAYOFWEEK(S.SC_TIME)
				WHEN 1 THEN "일"
				WHEN 2 THEN "월"
				WHEN 3 THEN "화"
				WHEN 4 THEN "수"
				WHEN 5 THEN "목"
				WHEN 6 THEN "금"
				WHEN 7 THEN "토"
			END AS dayWeek
		FROM SCREEN S JOIN CINEMA C
		ON S.CI_NUM = C.CI_NUM
		JOIN THEATER T ON C.TH_NUM = T.TH_NUM
		WHERE now() &lt;= S.SC_TIME
		<if test="TH_NAME == null || TH_NAME.isEmpty()">
		AND TH_REGION = #{TH_REGION}
	    AND C.MOVIE_NUM = #{MOVIE_NUM}
	    </if>
	    <if test="TH_REGION == null || TH_REGION.isEmpty()">
	    AND C.TH_NUM IN (SELECT TH_NUM
						 FROM THEATER
		                 WHERE TH_NAME = #{TH_NAME})
	    </if>
	</select>
<!--  -->	
	
	<!-- 특정 극장의 특정일에 상영하는 모든 영화 리스트 -->
	<select id="getRunningMovie" resultType="map">
		SELECT S.CI_NUM AS CI_NUM
			, C.TH_NUM AS TH_NUM  
			, C.MOVIE_NUM AS MOVIE_NUM
			, T.TH_NUMBER AS TH_NUMBER
			, S.ROW AS "ROW"
			, S.COL AS "COL"
			, DATE_FORMAT(S.SC_TIME, '%Y-%m-%d/%H:%i:%s') AS SC_TIME
			, DATE_FORMAT(S.SC_TIME_END, '%Y-%m-%d/%H:%i:%s') AS SC_TIME_END
			, M.TITLE AS TITLE
			, M.RUNTIME AS RUNTIME
			, LEFT(M.RATING, 2) AS RATING
			, M.GENRE AS GENRE
			, M.RELEASEDATE AS "DATE"
			, ((M.RELEASEDATE - CURRENT_DATE())) AS D_DAY
		FROM CINEMA C
		JOIN SCREEN S ON C.CI_NUM = S.CI_NUM
		LEFT JOIN MOVIE M ON C.MOVIE_NUM = M.MOVIE_NUM
		JOIN THEATER T ON C.TH_NUM = T.TH_NUM
		WHERE C.TH_NUM IN (SELECT TH_NUM
							FROM THEATER
							WHERE TH_NAME = (SELECT TH_NAME
											 FROM THEATER
											 WHERE TH_NUM = #{TH_NUM}))
		AND DATE_FORMAT(S.SC_TIME, '%Y-%m-%d') = #{SC_DATE}
		ORDER BY M.RELEASEDATE, C.MOVIE_NUM;
	</select>
	
	
</mapper>  